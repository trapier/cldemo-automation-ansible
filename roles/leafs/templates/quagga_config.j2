{% set intvars = interfaces[ansible_hostname] -%}
!
router bgp {{ intvars.asn }}
    bgp router-id {{ intvars.loopback }}
    network {{ intvars.loopback }}/32
{% for network in networks %}
{% if networks[network].source == ansible_hostname %}
    network {{ network }}
{% endif %}
{% endfor %}
    maximum-paths 64
    bgp bestpath as-path multipath-relax
    bgp bestpath compare-routerid
    neighbor fabric peer-group
    neighbor fabric description Internal Fabric Network
    neighbor fabric advertisement-interval 0
    neighbor fabric timers 1 3
    neighbor fabric timers connect 3
    neighbor fabric prefix-list dc-spine in
    neighbor fabric prefix-list dc-spine out
{% for neighbor in intvars.neighbors %}
    neighbor {{ intvars.neighbors[neighbor].peer }} peer-group fabric
    neighbor {{ intvars.neighbors[neighbor].peer }} remote-as external
{% endfor %}
!
ip prefix-list dc-leaf-in seq 10 permit 0.0.0.0/0
ip prefix-list dc-leaf-in seq 20 permit 10.0.0.0/24 le 32
{% for network in networks %}
{% if networks[network].source != ansible_hostname %}
ip prefix-list dc-leaf-in seq {{ loop.index*10 + 20 }} permit {{ network }}
{% endif %}
{% endfor %}
ip prefix-list dc-leaf-in seq 500 deny any
ip prefix-list dc-leaf-out seq 10 permit 10.0.0.0/24 le 32
{% for network in networks %}
{% if networks[network].source == ansible_hostname %}
ip prefix-list dc-leaf-in seq {{ loop.index*10 + 20 }} permit {{ network }}
{% endif %}
{% endfor %}
ip prefix-list dc-leaf-out seq 500 deny any
!
